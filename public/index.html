<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://api.jikan.moe; img-src 'self' https: data:;">
    <title>Anime Recommendations</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="stylesheet" href="/styles.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>üéå Anime Recommendations</h1>
            <p class="subtitle">{{ viewOnly ? 'Viewing shared anime recommendations' : 'Upload your MyAnimeList export to get personalized recommendations' }}</p>

            <div v-if="!listId && !hasRecommendations && history.length > 0" class="history">
                <h3>üìú Your Previous Lists</h3>
                <div class="history-list">
                    <a v-for="item in history" :key="item.id" :href="'/' + item.id" class="history-item">
                        <div class="history-info">
                            <div class="history-date">{{ formatDate(item.timestamp) }}</div>
                            <div class="history-stats">{{ item.stats.total }} anime ‚Ä¢ {{ item.stats.topRated }} top-rated</div>
                        </div>
                        <span class="history-arrow">‚Üí</span>
                    </a>
                </div>
            </div>

            <div v-if="!viewOnly" class="upload-area"
                 :class="{ 'drag-over': isDragging }"
                 @click="$refs.fileInput.click()"
                 @dragover.prevent="isDragging = true"
                 @dragenter.prevent="isDragging = true"
                 @dragleave.prevent="isDragging = false"
                 @drop.prevent="handleDrop">
                <input type="file" ref="fileInput" @change="handleFileUpload" accept=".xml,.gz">
                <div class="upload-label">
                    {{ fileName || 'üìÅ Click or drag & drop your animelist XML or GZ file' }}
                </div>
            </div>

            <div v-if="!viewOnly" class="settings" v-show="animeList.length > 0">
                <button @click="getRecommendations" :disabled="loading">
                    <span v-if="loading" class="spinner"></span>
                    {{ loading ? 'Get Recommendations' : `Analyze All ${topAnime.length} Top-Rated Anime` }}
                </button>
                <button v-if="shareUrl" @click="copyShareUrl" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    üìã Copy Share Link
                </button>
            </div>

            <div v-if="error" class="error">{{ error }}</div>

            <div v-if="stats && !hasRecommendations" class="stats">
                <h3>üìä Your Anime Stats</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total Anime</div>
                        <div class="stat-value">{{ stats.total }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Rated</div>
                        <div class="stat-value">{{ stats.rated }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Average Score</div>
                        <div class="stat-value">{{ stats.avgScore }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Top Rated (‚â•8)</div>
                        <div class="stat-value">{{ stats.topRated }}</div>
                    </div>
                </div>
            </div>

            <div v-if="topAnime.length > 0 && !hasRecommendations" class="top-anime">
                <h3>‚≠ê Your Top Anime</h3>
                <div class="anime-list">
                    <div v-for="anime in topAnime.slice(0, 12)" :key="anime.id" class="anime-item">
                        <img v-if="anime.image" :src="anime.image" :alt="anime.title" class="anime-cover">
                        <div class="anime-info">
                            <div class="anime-title">{{ anime.title }}</div>
                        </div>
                        <span class="anime-score">{{ anime.score }}</span>
                    </div>
                </div>
            </div>

            <div v-if="loading" class="progress">
                <strong>Fetching recommendations... {{ progress.current }}/{{ progress.total }}</strong>
                <div class="progress-bar">
                    <div class="progress-fill" :style="{ width: (progress.current / progress.total * 100) + '%' }"></div>
                </div>
                <p class="progress-text">{{ progress.currentAnime }}</p>
            </div>

            <div v-if="recommendations.length > 0" class="recommendations">
                <h2>‚ú® Recommended for You</h2>

                <!-- Filter and Sort Controls -->
                <div class="filter-controls">
                    <div class="search-box">
                        <input
                            v-model="searchQuery"
                            type="text"
                            placeholder="üîç Search recommendations..."
                            class="search-input"
                        >
                    </div>

                    <div class="filter-group">
                        <label>Type:</label>
                        <select v-model="filterType" class="filter-select">
                            <option value="">All Types</option>
                            <option value="TV">TV Series</option>
                            <option value="Movie">Movies</option>
                            <option value="OVA">OVA</option>
                            <option value="Special">Special</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Sort by:</label>
                        <select v-model="sortBy" class="filter-select">
                            <option value="count">Most Recommended</option>
                            <option value="score">Highest Rated</option>
                            <option value="title">Title (A-Z)</option>
                        </select>
                    </div>

                    <div class="result-count">
                        Showing {{ paginatedRecommendations.length }} of {{ filteredRecommendations.length }}
                        <span v-if="filteredRecommendations.length !== recommendations.length">
                            ({{ recommendations.length }} total)
                        </span>
                    </div>
                </div>

                <div class="rec-grid">
                    <div v-for="(rec, idx) in paginatedRecommendations" :key="rec.title" class="rec-item">
                        <img v-if="rec.image" :src="rec.image" :alt="rec.title" class="rec-cover">
                        <div class="rec-content">
                            <div class="rec-header">
                                <span class="rec-rank">{{ (currentPage - 1) * itemsPerPage + idx + 1 }}</span>
                                <div class="rec-title">{{ rec.title }}</div>
                            </div>
                            <div class="rec-count">
                                Recommended {{ rec.count }} time{{ rec.count > 1 ? 's' : '' }}
                                <span v-if="rec.score" style="margin-left: 10px; color: #667eea;">
                                    ‚≠ê {{ rec.score }}
                                </span>
                            </div>
                            <span v-if="rec.type" class="rec-type">{{ rec.type }}</span>
                        </div>
                    </div>
                </div>

                <!-- Pagination Controls -->
                <div v-if="totalPages > 1" class="pagination">
                    <button @click="currentPage = 1" :disabled="currentPage === 1" class="page-btn">
                        ¬´ First
                    </button>
                    <button @click="currentPage--" :disabled="currentPage === 1" class="page-btn">
                        ‚Äπ Prev
                    </button>

                    <div class="page-numbers">
                        <button
                            v-for="page in visiblePages"
                            :key="page"
                            @click="currentPage = page"
                            :class="['page-btn', { active: currentPage === page }]"
                        >
                            {{ page }}
                        </button>
                    </div>

                    <button @click="currentPage++" :disabled="currentPage === totalPages" class="page-btn">
                        Next ‚Ä∫
                    </button>
                    <button @click="currentPage = totalPages" :disabled="currentPage === totalPages" class="page-btn">
                        Last ¬ª
                    </button>
                </div>

                <div v-if="filteredRecommendations.length === 0" class="no-results">
                    No recommendations match your filters. Try adjusting your search or filters.
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initApp } from './js/app.js';

        const app = initApp();
        app.mount('#app');
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</body>
</html>
